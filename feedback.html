<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anytime Shift - Beta Feedback</title>

  <style>
    :root{
      --blue:#001f3f;
      --red:#d71920;
      --bg:#f5f7fb;
      --text:#0f172a;
      --muted:#4b5563;
      --card:#ffffff;
      --border:#d1d5db;
      --shadow:0 14px 30px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 28px 14px;
    }
    .container{max-width: 860px; margin: 0 auto;}
    .card{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 22px;
    }
    header{
      text-align:center;
      margin-bottom: 14px;
    }
    .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-bottom: 8px;
    }
    .logo img{width: 240px; max-width: 75%; height:auto; display:block;}
    .subtitle{color: var(--red); font-weight: 800; font-size: 14px;}
    h1{margin: 10px 0 6px; font-size: 26px;}
    .intro{color: var(--muted); margin: 0 auto 16px; max-width: 65ch; line-height: 1.5;}
    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.12);
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .section{
      border-top: 1px solid rgba(15,23,42,0.08);
      padding-top: 18px;
      margin-top: 18px;
    }
    .section h2{margin: 0 0 8px; font-size: 18px; color: var(--blue);}
    .help{margin: 0 0 14px; color: var(--muted); font-size: 14px; line-height: 1.45;}
    .q{margin: 16px 0;}
    .q label.title{display:block; font-weight: 800; margin-bottom: 10px;}

    /* Rating */
    .rating-block{
      max-width: 520px;
    }
    .rating-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .rate-btn{
      width: 74px;
      padding: 14px 0;
      border-radius: 14px;
      border: 2px solid var(--border);
      background:#fff;
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      transition: all 0.15s ease;
    }
    .rate-btn:hover{
      border-color: rgba(30,58,138,0.45);
    }
    .rate-btn.selected{
      border-color: #1e3a8a;
      background: #eef2ff;
      box-shadow: 0 6px 16px rgba(30,58,138,0.15);
    }
    .scale-labels{
      display:flex;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      padding: 0 2px;
    }

    /* Yes/No */
    .yn-row{display:flex; gap:10px; flex-wrap:wrap;}
    .yn-btn{
      padding: 12px 14px;
      border-radius: 14px;
      border: 2px solid var(--border);
      background:#fff;
      font-weight: 800;
      cursor:pointer;
      transition: all 0.15s ease;
      min-width: 120px;
    }
    .yn-btn:hover{ border-color: rgba(30,58,138,0.45); }
    .yn-btn.selected{
      border-color: #1e3a8a;
      background: #eef2ff;
      box-shadow: 0 6px 16px rgba(30,58,138,0.15);
    }

    textarea{
      width: 100%;
      border: 2px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      min-height: 110px;
      font-size: 14px;
      resize: vertical;
    }
    textarea:focus{
      outline: none;
      border-color: rgba(0,31,63,0.45);
      box-shadow: 0 0 0 3px rgba(0,31,63,0.10);
    }

    .actions{
      margin-top: 18px;
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
    }

    .primary-btn{
      border: 0;
      border-radius: 14px;
      padding: 14px 18px;
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      background: #1e3a8a;
      color:#fff;
      box-shadow: 0 10px 18px rgba(0,31,63,0.16);
      transition: background 0.15s ease;
    }
    .primary-btn:active{ transform: translateY(1px); }
    .primary-btn:disabled{
      background: #9aa6c2;
      box-shadow:none;
      cursor:not-allowed;
      transform:none;
    }

    .status{color: var(--muted); font-size: 14px;}
    .hide{display:none !important;}

    .success{
      text-align:center;
      padding: 10px 8px;
    }
    .check{
      width: 72px;
      height: 72px;
      border-radius: 999px;
      margin: 14px auto;
      display:grid;
      place-items:center;
      font-size: 34px;
      font-weight: 900;
      color: var(--red);
      border: 3px solid rgba(215,25,32,0.35);
      background: rgba(215,25,32,0.06);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card" id="formView">
      <header>
        <div class="logo">
          <img src="/anytimeshift-logo.png" alt="Anytime Shift" />
        </div>
        <div class="subtitle">Beta Feedback</div>
        <h1>Help us improve</h1>
        <p class="intro">This takes about 2–4 minutes.</p>
        <div class="pill" id="contextPill">Loading your form…</div>
      </header>

      <form id="feedbackForm" novalidate>
        <input type="hidden" name="token" id="token" />
        <input type="hidden" name="role" id="role" />

        <div class="section">
          <h2>Getting started</h2>
          <p class="help">Rate from 1 (Poor) to 5 (Excellent).</p>

          <div class="q">
            <label class="title">1) Registration + login experience</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="loginEase" data-left="Poor" data-right="Excellent"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="loginEase" id="loginEase" />
          </div>

          <div class="q">
            <label class="title">2) Login method clarity (Email/Google)</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="loginMethod" data-left="Confusing" data-right="Very clear"></div>
              <div class="scale-labels"><span>Confusing</span><span>Very clear</span></div>
            </div>
            <input type="hidden" name="loginMethod" id="loginMethod" />
          </div>

          <div class="q">
            <label class="title">3) Any issues while signing up or logging in?</label>
            <div class="yn-row" data-yn="loginIssues">
              <button type="button" class="yn-btn" data-value="No">No</button>
              <button type="button" class="yn-btn" data-value="Yes">Yes</button>
            </div>
            <input type="hidden" name="loginIssues" id="loginIssues" />
          </div>

          <div class="q">
            <label class="title">4) If yes, what happened?</label>
            <textarea name="loginIssueDetails" placeholder="Example: OTP didn’t arrive, error message, stuck on loading…"></textarea>
          </div>
        </div>

        <div class="section">
          <h2>Navigating the app</h2>
          <p class="help">Rate from 1 (Poor) to 5 (Excellent).</p>

          <div class="q">
            <label class="title">5) After login, was it clear what to do first?</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="firstStepClarity"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="firstStepClarity" id="firstStepClarity" />
          </div>

          <div class="q">
            <label class="title">6) Did any steps feel unnecessary or repeated?</label>
            <div class="yn-row" data-yn="repetitiveSteps">
              <button type="button" class="yn-btn" data-value="No">No</button>
              <button type="button" class="yn-btn" data-value="Yes">Yes</button>
            </div>
            <input type="hidden" name="repetitiveSteps" id="repetitiveSteps" />
          </div>

          <div class="q">
            <label class="title">7) If yes, which steps felt repeated?</label>
            <textarea name="repetitiveStepsDetails" placeholder="Tell us which screen/step and what felt repeated."></textarea>
          </div>

          <div class="q">
            <label class="title">8) Overall navigation ease</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="navigationEase"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="navigationEase" id="navigationEase" />
          </div>
        </div>

        <div class="section hide" id="employeeSection">
          <h2>Instant jobs (Shift Seeker)</h2>
          <p class="help">Rate from 1 (Poor) to 5 (Excellent).</p>

          <div class="q">
            <label class="title">9) Finding instant jobs near you</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="emp_findJobs"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="emp_findJobs" id="emp_findJobs" />
          </div>

          <div class="q">
            <label class="title">10) Job details clarity (time, location, pay)</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="emp_jobDetailsClarity"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="emp_jobDetailsClarity" id="emp_jobDetailsClarity" />
          </div>

          <div class="q">
            <label class="title">11) Accept / reject experience</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="emp_acceptEase"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="emp_acceptEase" id="emp_acceptEase" />
          </div>

          <div class="q">
            <label class="title">12) Any confusing steps during the job flow?</label>
            <textarea name="emp_jobFlowIssues" placeholder="Arrival/start/end, confirmations, anything unclear…"></textarea>
          </div>
        </div>

        <div class="section hide" id="employerSection">
          <h2>Instant jobs (Business)</h2>
          <p class="help">Rate from 1 (Poor) to 5 (Excellent).</p>

          <div class="q">
            <label class="title">9) Creating an instant job</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="biz_createJob"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="biz_createJob" id="biz_createJob" />
          </div>

          <div class="q">
            <label class="title">10) Entering job details (time, location, pay, role)</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="biz_jobDetails"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="biz_jobDetails" id="biz_jobDetails" />
          </div>

          <div class="q">
            <label class="title">11) Tracking who accepted/rejected</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="biz_candidateVisibility"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="biz_candidateVisibility" id="biz_candidateVisibility" />
          </div>

          <div class="q">
            <label class="title">12) Anything missing or unclear?</label>
            <textarea name="biz_missingInfo" placeholder="Example: confirmation, status, pay breakdown, location…"></textarea>
          </div>
        </div>

        <div class="section">
          <h2>Stripe setup & payments</h2>
          <p class="help">Rate from 1 (Poor) to 5 (Excellent).</p>

          <div class="q">
            <label class="title">13) Stripe setup experience</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="stripeEase"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="stripeEase" id="stripeEase" />
          </div>

          <div class="q">
            <label class="title">14) Was it clear why Stripe setup was needed?</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="stripeWhyClear"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="stripeWhyClear" id="stripeWhyClear" />
          </div>

          <div class="q">
            <label class="title">15) Any Stripe or payment issues?</label>
            <textarea name="stripeIssues" placeholder="Verification, bank link, errors, stuck on loading…"></textarea>
          </div>

          <div class="q">
            <label class="title">16) Payment flow clarity (after job is done)</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="paymentClarity"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="paymentClarity" id="paymentClarity" />
          </div>
        </div>

        <div class="section">
          <h2>Overall</h2>
          <p class="help">Rate from 1 (Poor) to 5 (Excellent).</p>

          <div class="q">
            <label class="title">17) Overall rating</label>
            <div class="rating-block">
              <div class="rating-row" data-rating="overallRating"></div>
              <div class="scale-labels"><span>Poor</span><span>Excellent</span></div>
            </div>
            <input type="hidden" name="overallRating" id="overallRating" />
          </div>

          <div class="q">
            <label class="title">18) What worked really well?</label>
            <textarea name="workedWell" placeholder="Tell us what you liked most."></textarea>
          </div>

          <div class="q">
            <label class="title">19) What was the most frustrating or confusing part?</label>
            <textarea name="mostFrustrating" placeholder="Tell us what to fix first."></textarea>
          </div>

          <div class="q">
            <label class="title">20) What ONE change would make the app much better?</label>
            <textarea name="oneImprovement" placeholder="One improvement that would make a big difference."></textarea>
          </div>
        </div>

        <div class="actions">
          <button class="primary-btn" id="submitBtn" type="submit" disabled>Submit feedback</button>
          <div class="status" id="status"></div>
        </div>
      </form>
    </div>

    <div class="card hide" id="successView">
      <div class="success">
        <div class="logo">
          <img src="/anytimeshift-logo.png" alt="Anytime Shift" />
        </div>
        <div class="subtitle">Beta Feedback</div>
        <div class="check">✓</div>
        <h2>Thank you!</h2>
        <p class="intro">Your feedback was submitted successfully.</p>
      </div>
    </div>
  </div>

  <script>
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxc5XmLcS3WgN8_jojcZFPz2HPqcKHYo4zEtDURqiQQ2Gb7IklEZ4m8yReqbBGrFGEb/exec";

    const qs = new URLSearchParams(location.search);
    const token = qs.get('token') || '';
    const roleFromUrl = (qs.get('role') || '').toLowerCase();

    const tokenEl = document.getElementById('token');
    const roleEl = document.getElementById('role');
    const pillEl = document.getElementById('contextPill');

    const employeeSection = document.getElementById('employeeSection');
    const employerSection = document.getElementById('employerSection');

    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    function normalizeRole(r){
      const x = String(r || '').toLowerCase().trim();
      if (!x) return '';
      if (x.includes('employer') || x.includes('business')) return 'employer';
      if (x.includes('employee') || x.includes('shift')) return 'employee';
      return x;
    }

    function enableSubmitIfReady(){
      const ok = Boolean(tokenEl.value);
      submitBtn.disabled = !ok;
      if (!ok) statusEl.textContent = "Missing token. Please open the feedback link from your email.";
      else statusEl.textContent = "";
    }

    function showRole(role){
      const normalized = normalizeRole(role);

      employeeSection.classList.add('hide');
      employerSection.classList.add('hide');

      if (normalized === 'employee') {
        employeeSection.classList.remove('hide');
        pillEl.textContent = 'Form: Shift Seeker (Employee)';
      } else if (normalized === 'employer') {
        employerSection.classList.remove('hide');
        pillEl.textContent = 'Form: Business (Employer)';
      } else {
        pillEl.textContent = 'Form: (Role not found — please use the email link)';
      }

      roleEl.value = normalized;
      enableSubmitIfReady();
    }

    function buildRatingControls(){
      document.querySelectorAll('.rating-row').forEach(row => {
        const field = row.getAttribute('data-rating');
        if (!field) return;

        // 1..5 buttons
        for (let i = 1; i <= 5; i++){
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'rate-btn';
          btn.textContent = String(i);
          btn.addEventListener('click', () => {
            row.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            const hidden = document.getElementById(field);
            if (hidden) hidden.value = String(i);
          });
          row.appendChild(btn);
        }
      });
    }

    function buildYesNoControls(){
      document.querySelectorAll('.yn-row').forEach(row => {
        const field = row.getAttribute('data-yn');
        if (!field) return;

        row.querySelectorAll('.yn-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            row.querySelectorAll('.yn-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            const hidden = document.getElementById(field);
            if (hidden) hidden.value = btn.getAttribute('data-value');
          });
        });
      });
    }

    async function loadContext(){
      tokenEl.value = token;
      enableSubmitIfReady();

      if (roleFromUrl) {
        showRole(roleFromUrl);
        return;
      }

      if (!token) return;

      try {
        const url = `${GAS_ENDPOINT}?action=getFeedbackContext&token=${encodeURIComponent(token)}`;
        const res = await fetch(url, { method: 'GET' });
        const data = await res.json();
        if (data && data.role) showRole(data.role);
        else showRole('');
      } catch (e) {
        showRole('');
      }
    }

    buildRatingControls();
    buildYesNoControls();
    loadContext();

    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!tokenEl.value) {
        statusEl.textContent = "Missing token. Please open the feedback link from your email.";
        return;
      }

      statusEl.textContent = 'Submitting…';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting…';

      const fd = new FormData(e.target);
      const payload = { token: fd.get('token') || '', role: fd.get('role') || '' };

      for (const [k, v] of fd.entries()) {
        if (k === 'token' || k === 'role') continue;
        payload[k] = v;
      }

      try {
        const res = await fetch('/.netlify/functions/submitFeedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Failed to submit');

        document.getElementById('formView').classList.add('hide');
        document.getElementById('successView').classList.remove('hide');
      } catch (err) {
        statusEl.textContent = err.message || 'Something went wrong. Please try again.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit feedback';
      }
    });
  </script>
</body>
</html>
